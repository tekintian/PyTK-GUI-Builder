name: PyTK GUI Builder CI

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # 匹配v开头的tag，如v1.0.0, v2.1.3等
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15-intel, ubuntu-latest, windows-latest]
        include:
          - os: macos-15-intel
            platform: Darwin64
            python-version: '3.11'
          - os: ubuntu-latest
            platform: Linux64
            python-version: '3.11'
          - os: windows-latest
            platform: win64
            python-version: '3.11'
            architecture: 'x64'
          - os: windows-latest
            platform: win32
            python-version: '3.11'
            architecture: 'x86'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture || 'x64' }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # Install create-dmg for macOS DMG creation
        if [ "${{ matrix.platform }}" = "Darwin64" ]; then
          brew install create-dmg
        fi
      shell: bash

    - name: Build with PyInstaller
      run: pyinstaller pytk_gui_builder.spec

    - name: Create release archive
      run: |
        # Create appropriate archive based on platform
        if [ "${{ matrix.platform }}" = "Darwin64" ]; then
          # For macOS, create both zip and DMG formats
          # First create zip archive of the app bundle
          zip -r pytk_gui_builder-${{ matrix.platform }}.zip dist/pytk_gui_builder.app
          
          # Create DMG with professional layout optimized for 1200x722 background
          create-dmg \
            --volname "PyTK GUI Builder" \
            --volicon "assets/app.icns" \
            --background "assets/macapp_bg.png" \
            --window-pos 200 120 \
            --window-size 800 480 \
            --icon-size 120 \
            --icon "pytk_gui_builder.app" 200 280 \
            --hide-extension "pytk_gui_builder.app" \
            --app-drop-link 600 280 \
            --no-internet-enable \
            "pytk_gui_builder-${{ matrix.platform }}.dmg" \
            "dist/pytk_gui_builder.app"
        elif [ "${{ matrix.platform }}" = "Linux64" ]; then
          # For Linux, create a tar.gz archive
          tar -czf pytk_gui_builder-${{ matrix.platform }}.tar.gz -C dist .
        elif [[ "${{ matrix.platform }}" = "win32" || "${{ matrix.platform }}" = "win64" ]]; then
          # For Windows, create a zip archive
          powershell Compress-Archive -Path dist/* -DestinationPath pytk_gui_builder-${{ matrix.platform }}.zip
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pytk_gui_builder-${{ matrix.platform }}
        path: pytk_gui_builder-${{ matrix.platform }}.*

    - name: Upload to GitHub Release
      if: (github.event_name == 'release' && github.event.action == 'published') || startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: pytk_gui_builder-${{ matrix.platform }}.*
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          PyTK GUI Builder ${{ github.ref_name }}
          
          ## 更新内容
          - 跨平台GUI构建工具
          - 支持Windows、macOS、Linux
          - 拖放式界面设计
          - 生成纯Python 3代码
          
          ## 下载说明
          根据您的操作系统选择对应的构建版本：
          - **Windows**: 选择 `pytk_gui_builder-win64.zip` 或 `pytk_gui_builder-win32.zip`
          - **macOS**: 选择 `pytk_gui_builder-Darwin64.dmg` (推荐) 或 `pytk_gui_builder-Darwin64.zip`
          - **Linux**: 选择 `pytk_gui_builder-Linux64.tar.gz`
          
          ## 使用说明
          **macOS**: 下载DMG文件后，双击打开，将应用拖拽到Applications文件夹即可
          **Windows/Linux**: 下载对应平台的压缩包，解压后直接运行可执行文件即可开始使用
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}